<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Worker Deployment Status</title>
    <style>
      :root {
        --bg: #2d2d2d;
        --bg-input: #3d3d3d;
        --border: #565656;
        --text: #d8d8d8;
        --text-muted: #969696;
        --accent: #0078d4;
        --error: #ff6b6b;
        --success: #4ade80;
        --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        background: var(--bg);
        color: var(--text);
        font-family: var(--font);
        font-size: 12px;
        line-height: 1.4;
        padding: 0;
        min-height: 100vh;
      }

      .sdpi-item {
        display: flex;
        align-items: center;
        min-height: 32px;
        padding: 4px 16px;
        gap: 8px;
      }

      .sdpi-item-label {
        flex: 0 0 80px;
        text-align: right;
        color: var(--text-muted);
        font-size: 11px;
        white-space: nowrap;
      }

      .sdpi-item-value {
        flex: 1;
        min-width: 0;
      }

      input[type="text"],
      input[type="password"],
      input[type="number"],
      select {
        width: 100%;
        background: var(--bg-input);
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 3px;
        padding: 4px 8px;
        font-family: var(--font);
        font-size: 12px;
        outline: none;
      }

      input:focus,
      select:focus {
        border-color: var(--accent);
      }

      select {
        cursor: pointer;
        appearance: auto;
      }

      .worker-row {
        display: flex;
        gap: 4px;
        align-items: stretch;
      }

      .worker-row select {
        flex: 1;
      }

      .load-btn {
        flex: 0 0 auto;
        background: var(--bg-input);
        color: var(--text-muted);
        border: 1px solid var(--border);
        border-radius: 3px;
        padding: 4px 5px 2px;
        cursor: pointer;
        font-size: 12px;
        font-family: var(--font);
        white-space: nowrap;
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .load-btn:hover {
        background: #4d4d4d;
        color: var(--text);
      }

      .load-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .status-msg {
        font-size: 10px;
        color: var(--text-muted);
        padding: 0 16px 0 96px;
        min-height: 14px;
      }

      details {
        margin: 8px 16px;
      }

      summary {
        cursor: pointer;
        color: var(--text-muted);
        font-size: 11px;
      }

      .help-content {
        color: #808080;
        font-size: 11px;
        margin: 4px 0 8px;
      }

      .help-content ol {
        padding-left: 16px;
        margin: 4px 0;
      }

      .help-content p {
        margin: 4px 0;
      }

      .separator {
        border: none;
        border-top: 1px solid var(--border);
        margin: 8px 16px;
      }
    </style>
  </head>
  <body>
    <div class="sdpi-item">
      <div class="sdpi-item-label">API Token</div>
      <div class="sdpi-item-value">
        <input
          type="password"
          id="apiToken"
          placeholder="Your Cloudflare API Token"
        />
      </div>
    </div>

    <div class="sdpi-item">
      <div class="sdpi-item-label">Account</div>
      <div class="sdpi-item-value">
        <div class="worker-row">
          <select id="accountId">
            <option value="">-- Select Account --</option>
          </select>
          <button type="button" id="loadAccountsBtn" class="load-btn" title="Load accounts from Cloudflare">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6"/><path d="M21.34 13a10 10 0 1 1-2.83-7.83L21.5 8"/></svg>
          </button>
        </div>
      </div>
    </div>
    <div class="status-msg" id="accountStatus"></div>

    <div class="sdpi-item">
      <div class="sdpi-item-label">Worker</div>
      <div class="sdpi-item-value">
        <div class="worker-row">
          <select id="workerName">
            <option value="">-- Select Worker --</option>
          </select>
          <button type="button" id="loadWorkersBtn" class="load-btn" title="Load workers from Cloudflare">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6"/><path d="M21.34 13a10 10 0 1 1-2.83-7.83L21.5 8"/></svg>
          </button>
        </div>
      </div>
    </div>
    <div class="status-msg" id="workerStatus"></div>

    <div class="sdpi-item">
      <div class="sdpi-item-label">Refresh (s)</div>
      <div class="sdpi-item-value">
        <input
          type="number"
          id="refreshIntervalSeconds"
          placeholder="60"
          min="10"
          max="3600"
        />
      </div>
    </div>

    <hr class="separator" />

    <details>
      <summary>How to create an API Token</summary>
      <div class="help-content">
        <ol>
          <li>Go to <em>Cloudflare Dashboard → Manage Account → Account API Tokens</em></li>
          <li>Click <em>Create Token</em></li>
          <li>Use the <em>Read all resources</em> template</li>
          <li>Save and paste the token above</li>
          <li>Click the refresh button next to Account to load your accounts</li>
        </ol>
      </div>
    </details>

    <script>
      /* ───────── Stream Deck WebSocket ───────── */
      let websocket = null;
      let piUUID = "";
      let settings = {};

      const CF_API = "https://api.cloudflare.com/client/v4";
      const REFRESH_ICON = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6"/><path d="M21.34 13a10 10 0 1 1-2.83-7.83L21.5 8"/></svg>';

      function connectElgatoStreamDeckSocket(
        port,
        uuid,
        registerEvent,
        info,
        actionInfo
      ) {
        piUUID = uuid;

        try {
          const action = JSON.parse(actionInfo);
          settings = action?.payload?.settings || {};
        } catch {
          settings = {};
        }

        websocket = new WebSocket("ws://127.0.0.1:" + port);

        websocket.onopen = function () {
          websocket.send(
            JSON.stringify({ event: registerEvent, uuid: uuid })
          );
          populateForm();
          // Auto-load chain if token is present
          if (settings.apiToken) {
            loadAccounts(/* then */ true);
          }
        };

        websocket.onmessage = function (evt) {
          try {
            const data = JSON.parse(evt.data);
            if (data.event === "didReceiveSettings") {
              settings = data?.payload?.settings || {};
              populateForm();
            }
          } catch {
            // ignore
          }
        };
      }

      /* ───────── Settings ↔ Form ───────── */

      const FIELDS = [
        "apiToken",
        "accountId",
        "workerName",
        "refreshIntervalSeconds",
      ];

      function populateForm() {
        FIELDS.forEach(function (key) {
          const el = document.getElementById(key);
          if (el) el.value = settings[key] || "";
        });

        // Ensure saved accountId is an option
        ensureOption("accountId", settings.accountId);
        // Ensure saved workerName is an option
        ensureOption("workerName", settings.workerName);
      }

      function ensureOption(selectId, value) {
        if (!value) return;
        const sel = document.getElementById(selectId);
        if (!sel.querySelector('option[value="' + CSS.escape(value) + '"]')) {
          const opt = document.createElement("option");
          opt.value = value;
          opt.textContent = value;
          sel.appendChild(opt);
          sel.value = value;
        }
      }

      function saveSettings() {
        FIELDS.forEach(function (key) {
          const el = document.getElementById(key);
          if (el) settings[key] = el.value;
        });

        if (websocket && websocket.readyState === WebSocket.OPEN) {
          websocket.send(
            JSON.stringify({
              event: "setSettings",
              context: piUUID,
              payload: settings,
            })
          );
        }
      }

      // Bind change/input events
      FIELDS.forEach(function (key) {
        var el = document.getElementById(key);
        if (el) {
          el.addEventListener("input", saveSettings);
          el.addEventListener("change", saveSettings);
        }
      });

      // When account changes, auto-load workers
      document.getElementById("accountId").addEventListener("change", function () {
        saveSettings();
        if (this.value) {
          loadWorkers();
        }
      });

      /* ───────── Shared helpers ───────── */

      function cfHeaders(token) {
        return {
          Authorization: "Bearer " + token,
          "Content-Type": "application/json",
        };
      }

      function showStatus(el, msg, type) {
        el.textContent = msg;
        el.style.color =
          type === "error"
            ? "#ff6b6b"
            : type === "success"
              ? "#4ade80"
              : "#969696";
      }

      function populateSelect(selectEl, items, placeholder, currentValue) {
        selectEl.innerHTML = "";
        var ph = document.createElement("option");
        ph.value = "";
        ph.textContent = placeholder;
        selectEl.appendChild(ph);

        items.forEach(function (item) {
          var opt = document.createElement("option");
          opt.value = item.value;
          opt.textContent = item.label;
          selectEl.appendChild(opt);
        });

        if (currentValue) {
          selectEl.value = currentValue;
        }
      }

      /* ───────── Account List Fetch ───────── */

      const loadAccountsBtn = document.getElementById("loadAccountsBtn");
      const accountSelect = document.getElementById("accountId");
      const accountStatusDiv = document.getElementById("accountStatus");

      loadAccountsBtn.addEventListener("click", function () {
        loadAccounts(/* thenLoadWorkers */ true);
      });

      async function loadAccounts(thenLoadWorkers) {
        const apiToken = document.getElementById("apiToken").value.trim();

        if (!apiToken) {
          showStatus(accountStatusDiv, "Enter API Token first", "error");
          return;
        }

        loadAccountsBtn.disabled = true;
        showStatus(accountStatusDiv, "Loading accounts…", "info");

        try {
          const resp = await fetch(CF_API + "/accounts", {
            headers: cfHeaders(apiToken),
          });

          if (!resp.ok) {
            var errText = "HTTP " + resp.status;
            if (resp.status === 401 || resp.status === 403) {
              errText = "Invalid token or insufficient permissions";
            }
            throw new Error(errText);
          }

          const data = await resp.json();

          if (!data.success || !Array.isArray(data.result)) {
            var msg =
              (data.errors && data.errors[0] && data.errors[0].message) ||
              "Unknown API error";
            throw new Error(msg);
          }

          var currentValue = accountSelect.value;

          var accounts = data.result
            .map(function (a) {
              return { value: a.id, label: a.name || a.id };
            })
            .sort(function (a, b) {
              return a.label.localeCompare(b.label);
            });

          populateSelect(
            accountSelect,
            accounts,
            "-- Select Account --",
            currentValue
          );

          var count = accounts.length;
          showStatus(
            accountStatusDiv,
            count + " account" + (count !== 1 ? "s" : "") + " found",
            "success"
          );

          // Auto-select if only one account
          if (accounts.length === 1 && !currentValue) {
            accountSelect.value = accounts[0].value;
            saveSettings();
          }

          // Chain: load workers if account is selected
          if (thenLoadWorkers && accountSelect.value) {
            loadWorkers();
          }
        } catch (err) {
          showStatus(
            accountStatusDiv,
            err.message || "Failed to load accounts",
            "error"
          );
        } finally {
          loadAccountsBtn.disabled = false;
        }
      }

      /* ───────── Worker List Fetch ───────── */

      const loadWorkersBtn = document.getElementById("loadWorkersBtn");
      const workerSelect = document.getElementById("workerName");
      const workerStatusDiv = document.getElementById("workerStatus");

      loadWorkersBtn.addEventListener("click", function () {
        loadWorkers();
      });

      async function loadWorkers() {
        const apiToken = document.getElementById("apiToken").value.trim();
        const accountId = document.getElementById("accountId").value.trim();

        if (!apiToken || !accountId) {
          showStatus(workerStatusDiv, "Select an account first", "error");
          return;
        }

        loadWorkersBtn.disabled = true;
        showStatus(workerStatusDiv, "Loading workers…", "info");

        try {
          const resp = await fetch(
            CF_API +
              "/accounts/" +
              encodeURIComponent(accountId) +
              "/workers/scripts",
            { headers: cfHeaders(apiToken) }
          );

          if (!resp.ok) {
            var errText = "HTTP " + resp.status;
            if (resp.status === 401 || resp.status === 403) {
              errText = "Invalid token or insufficient permissions";
            } else if (resp.status === 404) {
              errText = "Account not found";
            }
            throw new Error(errText);
          }

          const data = await resp.json();

          if (!data.success || !Array.isArray(data.result)) {
            var msg =
              (data.errors && data.errors[0] && data.errors[0].message) ||
              "Unknown API error";
            throw new Error(msg);
          }

          var currentValue = workerSelect.value;

          var workers = data.result
            .map(function (w) {
              return { value: w.id, label: w.id };
            })
            .sort(function (a, b) {
              return a.label.localeCompare(b.label);
            });

          populateSelect(
            workerSelect,
            workers,
            "-- Select Worker --",
            currentValue
          );

          var count = workers.length;
          showStatus(
            workerStatusDiv,
            count + " worker" + (count !== 1 ? "s" : "") + " found",
            "success"
          );
        } catch (err) {
          showStatus(
            workerStatusDiv,
            err.message || "Failed to load workers",
            "error"
          );
        } finally {
          loadWorkersBtn.disabled = false;
        }
      }
    </script>
  </body>
</html>
